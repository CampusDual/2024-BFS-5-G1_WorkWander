<?xml version="1.0" encoding="UTF-8"?>
<JdbcEntitySetup xmlns="http://www.ontimize.com/schema/jdbc"
                 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 xsi:schemaLocation="http://www.ontimize.com/schema/jdbc http://www.ontimize.com/schema/jdbc/ontimize-jdbc-dao.xsd"
                 catalog="" schema="${mainschema}" table="coworking" datasource="mainDataSource"
                 sqlhandler="dbSQLStatementHandler">
    <DeleteKeys>
        <Column>cw_id</Column>
    </DeleteKeys>
    <UpdateKeys>
        <Column>cw_id</Column>
    </UpdateKeys>
    <GeneratedKey>cw_id</GeneratedKey>
    <Queries>
        <Query id="serviceCoworking">
            <Sentence>
                <![CDATA[
                WITH temp_table AS(
                    SELECT
                        public.coworking.cw_id as cw_id,
                        public.coworking.cw_name as cw_name,
                        public.coworking.cw_description as cw_description,
                        public.coworking.cw_address as cw_address,
                        public.city.city as cw_location,
                        public.coworking.cw_capacity as cw_capacity,
                        public.coworking.cw_daily_price as cw_daily_price,
                        public.coworking.cw_image as cw_image,
                        STRING_AGG(distinct service.srv_name, ',') as services,
                        public.coworking.cw_usr_id as cw_usr_id,
                        Round(AVG(br.bkr_ratio), 1) as ratio
                    FROM coworking
                    LEFT JOIN cw_service on cw_service.cw_id = coworking.cw_id
                    LEFT JOIN service on service.srv_id = cw_service.srv_id
                    LEFT JOIN city on city.id_city = coworking.cw_location
                    LEFT join booking_rate br on coworking.cw_id = br.cw_id
                    GROUP BY public.coworking.cw_id, public.city.city)
                SELECT
                    #COLUMNS#
                    FROM
                        temp_table
                    #WHERE#
                ]]>
            </Sentence>
        </Query>
        <Query id="default">
            <Sentence>
                <![CDATA[
                WITH temp_table AS(
                    SELECT
                        public.coworking.cw_id as cw_id,
                        public.coworking.cw_name as cw_name,
                        public.coworking.cw_description as cw_description,
                        public.coworking.cw_address as cw_address,
                        public.coworking.cw_capacity as cw_capacity,
                        public.coworking.cw_location as cw_location,
                        public.city.city as location,
                        public.coworking.cw_daily_price as cw_daily_price,
                        public.coworking.cw_image as cw_image
                    FROM coworking
                    LEFT JOIN city on city.id_city = coworking.cw_location
                    #WHERE#
                    GROUP BY public.coworking.cw_id, public.coworking.cw_location, public.city.city)
                SELECT
                    #COLUMNS#
                    FROM
                        temp_table
                ]]>
            </Sentence>
        </Query>
        <Query id="coworkingCapacity">
            <Sentence>
                <![CDATA[
                SELECT
                    c.cw_capacity
                FROM
                    ${mainschema}.coworking c
                #WHERE#
                ]]>
            </Sentence>
        </Query>
        <Query id="coworkingsByUser">
            <Sentence>
                select cw_id,cw_name
                FROM {mainschema}.coworking c
                #WHERE# ORDER BY cw_id
            </Sentence>
        </Query>
        <Query id="coworkingNameById">
            <Sentence>
                SELECT cw_name
                FROM {mainschema}.coworking
                #WHERE#
            </Sentence>
        </Query>
        <Query id="filterDates">
            <Sentence>
                <![CDATA[
                WITH temp_table AS (
                    SELECT
                        cw.cw_id as cw_id,
                        cw.cw_name as cw_name,
                        bd.date as date,
                        cw.cw_capacity as cw_capacity,
                        cw.cw_daily_price as cw_daily_price,
                        public.city.city as cw_location,
                        STRING_AGG(service.srv_name, ',') as services,
                        COUNT(b.bk_id) as plazasOcupadas
                    FROM coworking cw
                    LEFT JOIN booking b ON cw.cw_id = b.bk_cw_id
                    LEFT JOIN booking_date bd ON b.bk_id = bd.bk_id
                    LEFT JOIN cw_service on cw_service.cw_id = cw.cw_id
                    LEFT JOIN service on service.srv_id = cw_service.srv_id
                    LEFT JOIN city on city.id_city = cw.cw_location
                    GROUP BY cw.cw_id, bd.date, city.city, cw.cw_capacity
                    )
                    SELECT
                        #COLUMNS#
                    FROM
                        temp_table
                    #WHERE#
                ]]>
            </Sentence>
        </Query>
    </Queries>
</JdbcEntitySetup>